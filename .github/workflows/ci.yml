name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
      - name: cargo fmt
        run: cargo fmt --all -- --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: cargo clippy
        run: cargo clippy --workspace --all-targets --locked -- -D warnings

  tests-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: cargo test (enigma-core)
        run: cargo test -p enigma-core --locked
      - name: cargo test (enigma-core sender-keys)
        run: cargo test -p enigma-core --locked --features sender-keys

  tests-daemon:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: cargo test (enigma-daemon)
        run: cargo test -p enigma-daemon --locked
      - name: cargo test (enigma-daemon all features)
        run: cargo test -p enigma-daemon --locked --all-features

  tests-workspace:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: cargo test (workspace)
        run: cargo test --locked
      - name: cargo test (workspace all features)
        run: cargo test --locked --all-features

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: cargo build --release
        run: cargo build --locked --release --workspace
      - name: cargo build --release --all-features
        run: cargo build --locked --release --workspace --all-features
      - name: version smoke
        run: |
          daemon_version="$(awk -F '\"' '/^version = \"/ {print $2; exit}' bins/enigma-daemon/Cargo.toml)"
          cli_version="$(awk -F '\"' '/^version = \"/ {print $2; exit}' bins/enigma-cli/Cargo.toml)"
          daemon_out="$(./target/release/enigma-daemon --version)"
          cli_out="$(./target/release/enigma-cli --version)"
          echo "$daemon_out" | grep -q "$daemon_version"
          echo "$cli_out" | grep -q "$cli_version"

  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: check pinned versions
        run: bash scripts/check_versions.sh
      - name: check docs
        run: bash scripts/check_docs.sh
      - name: check deployment docs
        run: bash scripts/check_deployment_docs.sh

  supply-chain:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: cargo deny check
        run: cargo deny check
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: cargo audit
        run: cargo audit
